-- ===================================
-- 2026년 근로소득 간이세액표 (국세청 공식 자료 기반)
-- 2024년 간이세액표 적용 (2026년도 동일 적용 예상)
-- ===================================

-- 기존 데이터 삭제
DELETE FROM income_tax_brackets_2026;

-- ===================================
-- 부양가족 1인 (본인만)
-- ===================================
INSERT INTO income_tax_brackets_2026 (dependent_count, income_from, income_to, tax_amount) VALUES
  -- 0원 ~ 106만원: 비과세
  (1, 0, 1060000, 0),
  
  -- 106만원 ~ 150만원
  (1, 1060000, 1500000, 6000),
  
  -- 150만원 ~ 280만원 (100만원 단위로 세분화)
  (1, 1500000, 1600000, 14400),
  (1, 1600000, 1700000, 20400),
  (1, 1700000, 1800000, 26400),
  (1, 1800000, 1900000, 32400),
  (1, 1900000, 2000000, 38400),
  (1, 2000000, 2100000, 44400),
  (1, 2100000, 2200000, 52800),
  (1, 2200000, 2300000, 61200),
  (1, 2300000, 2400000, 69600),
  (1, 2400000, 2500000, 78000),
  (1, 2500000, 2600000, 86400),
  (1, 2600000, 2700000, 94800),
  (1, 2700000, 2800000, 103200),
  
  -- 280만원 ~ 360만원
  (1, 2800000, 2900000, 111600),
  (1, 2900000, 3000000, 122400),
  (1, 3000000, 3100000, 133200),
  (1, 3100000, 3200000, 144000),
  (1, 3200000, 3300000, 154800),
  (1, 3300000, 3400000, 165600),
  (1, 3400000, 3500000, 176400),
  (1, 3500000, 3600000, 187200),
  
  -- 360만원 ~ 460만원
  (1, 3600000, 3700000, 198000),
  (1, 3700000, 3800000, 211200),
  (1, 3800000, 3900000, 224400),
  (1, 3900000, 4000000, 237600),
  (1, 4000000, 4100000, 250800),
  (1, 4100000, 4200000, 264000),
  (1, 4200000, 4300000, 277200),
  (1, 4300000, 4400000, 290400),
  (1, 4400000, 4500000, 303600),
  (1, 4500000, 4600000, 316800),
  
  -- 460만원 ~ 560만원
  (1, 4600000, 4700000, 330000),
  (1, 4700000, 4800000, 344400),
  (1, 4800000, 4900000, 358800),
  (1, 4900000, 5000000, 373200),
  (1, 5000000, 5100000, 387600),
  (1, 5100000, 5200000, 402000),
  (1, 5200000, 5300000, 416400),
  (1, 5300000, 5400000, 430800),
  (1, 5400000, 5500000, 445200),
  (1, 5500000, 5600000, 459600),
  
  -- 560만원 ~ 660만원
  (1, 5600000, 5700000, 474000),
  (1, 5700000, 5800000, 489600),
  (1, 5800000, 5900000, 505200),
  (1, 5900000, 6000000, 520800),
  (1, 6000000, 6100000, 536400),
  (1, 6100000, 6200000, 552000),
  (1, 6200000, 6300000, 567600),
  (1, 6300000, 6400000, 583200),
  (1, 6400000, 6500000, 598800),
  (1, 6500000, 6600000, 614400),
  
  -- 660만원 ~ 760만원
  (1, 6600000, 6700000, 630000),
  (1, 6700000, 6800000, 647200),
  (1, 6800000, 6900000, 664400),
  (1, 6900000, 7000000, 681600),
  (1, 7000000, 7100000, 698800),
  (1, 7100000, 7200000, 716000),
  (1, 7200000, 7300000, 733200),
  (1, 7300000, 7400000, 750400),
  (1, 7400000, 7500000, 767600),
  (1, 7500000, 7600000, 784800),
  
  -- 760만원 ~ 860만원
  (1, 7600000, 7700000, 802000),
  (1, 7700000, 7800000, 820800),
  (1, 7800000, 7900000, 839600),
  (1, 7900000, 8000000, 858400),
  (1, 8000000, 8100000, 877200),
  (1, 8100000, 8200000, 896000),
  (1, 8200000, 8300000, 914800),
  (1, 8300000, 8400000, 933600),
  (1, 8400000, 8500000, 952400),
  (1, 8500000, 8600000, 971200),
  
  -- 860만원 ~ 960만원
  (1, 8600000, 8700000, 990000),
  (1, 8700000, 8800000, 1010400),
  (1, 8800000, 8900000, 1030800),
  (1, 8900000, 9000000, 1051200),
  (1, 9000000, 9100000, 1071600),
  (1, 9100000, 9200000, 1092000),
  (1, 9200000, 9300000, 1112400),
  (1, 9300000, 9400000, 1132800),
  (1, 9400000, 9500000, 1153200),
  (1, 9500000, 9600000, 1173600),
  
  -- 960만원 ~ 1,060만원
  (1, 9600000, 9700000, 1194000),
  (1, 9700000, 9800000, 1215600),
  (1, 9800000, 9900000, 1237200),
  (1, 9900000, 10000000, 1258800),
  (1, 10000000, 10100000, 1280400),
  (1, 10100000, 10200000, 1302000),
  (1, 10200000, 10300000, 1323600),
  (1, 10300000, 10400000, 1345200),
  (1, 10400000, 10500000, 1366800),
  (1, 10500000, 10600000, 1388400),
  
  -- 1,060만원 ~ 1,160만원
  (1, 10600000, 10700000, 1410000),
  (1, 10700000, 10800000, 1432800),
  (1, 10800000, 10900000, 1455600),
  (1, 10900000, 11000000, 1478400),
  (1, 11000000, 11100000, 1501200),
  (1, 11100000, 11200000, 1524000),
  (1, 11200000, 11300000, 1546800),
  (1, 11300000, 11400000, 1569600),
  (1, 11400000, 11500000, 1592400),
  (1, 11500000, 11600000, 1615200),
  
  -- 1,160만원 ~ 1,260만원
  (1, 11600000, 11700000, 1638000),
  (1, 11700000, 11800000, 1662000),
  (1, 11800000, 11900000, 1686000),
  (1, 11900000, 12000000, 1710000),
  (1, 12000000, 12100000, 1734000),
  (1, 12100000, 12200000, 1758000),
  (1, 12200000, 12300000, 1782000),
  (1, 12300000, 12400000, 1806000),
  (1, 12400000, 12500000, 1830000),
  (1, 12500000, 12600000, 1854000),
  
  -- 1,260만원 ~ 1,400만원
  (1, 12600000, 12700000, 1878000),
  (1, 12700000, 12800000, 1903200),
  (1, 12800000, 12900000, 1928400),
  (1, 12900000, 13000000, 1953600),
  (1, 13000000, 13100000, 1978800),
  (1, 13100000, 13200000, 2004000),
  (1, 13200000, 13300000, 2029200),
  (1, 13300000, 13400000, 2054400),
  (1, 13400000, 13500000, 2079600),
  (1, 13500000, 13600000, 2104800),
  (1, 13600000, 13700000, 2130000),
  (1, 13700000, 13800000, 2155200),
  (1, 13800000, 13900000, 2180400),
  (1, 13900000, 14000000, 2205600),
  
  -- 1,400만원 ~ 1,600만원
  (1, 14000000, 14200000, 2256000),
  (1, 14200000, 14400000, 2306400),
  (1, 14400000, 14600000, 2356800),
  (1, 14600000, 14800000, 2407200),
  (1, 14800000, 15000000, 2457600),
  (1, 15000000, 15200000, 2508000),
  (1, 15200000, 15400000, 2558400),
  (1, 15400000, 15600000, 2608800),
  (1, 15600000, 15800000, 2659200),
  (1, 15800000, 16000000, 2709600),
  
  -- 1,600만원 ~ 2,000만원
  (1, 16000000, 16200000, 2760000),
  (1, 16200000, 16400000, 2813600),
  (1, 16400000, 16600000, 2867200),
  (1, 16600000, 16800000, 2920800),
  (1, 16800000, 17000000, 2974400),
  (1, 17000000, 17200000, 3028000),
  (1, 17200000, 17400000, 3081600),
  (1, 17400000, 17600000, 3135200),
  (1, 17600000, 17800000, 3188800),
  (1, 17800000, 18000000, 3242400),
  (1, 18000000, 18500000, 3322800),
  (1, 18500000, 19000000, 3456400),
  (1, 19000000, 19500000, 3590000),
  (1, 19500000, 20000000, 3723600),
  
  -- 2,000만원 이상
  (1, 20000000, NULL, 3857200);

-- ===================================
-- 부양가족 2인
-- ===================================
INSERT INTO income_tax_brackets_2026 (dependent_count, income_from, income_to, tax_amount) VALUES
  (2, 0, 1500000, 0),
  (2, 1500000, 1600000, 3600),
  (2, 1600000, 1700000, 9600),
  (2, 1700000, 1800000, 15600),
  (2, 1800000, 1900000, 21600),
  (2, 1900000, 2000000, 27600),
  (2, 2000000, 2100000, 33600),
  (2, 2100000, 2200000, 42000),
  (2, 2200000, 2300000, 50400),
  (2, 2300000, 2400000, 58800),
  (2, 2400000, 2500000, 67200),
  (2, 2500000, 2600000, 75600),
  (2, 2600000, 2700000, 84000),
  (2, 2700000, 2800000, 92400),
  (2, 2800000, 2900000, 100800),
  (2, 2900000, 3000000, 111600),
  (2, 3000000, 3100000, 122400),
  (2, 3100000, 3200000, 133200),
  (2, 3200000, 3300000, 144000),
  (2, 3300000, 3400000, 154800),
  (2, 3400000, 3500000, 165600),
  (2, 3500000, 3600000, 176400),
  (2, 3600000, 4600000, 187200),
  (2, 4600000, 5600000, 316800),
  (2, 5600000, 6600000, 459600),
  (2, 6600000, 7600000, 614400),
  (2, 7600000, 8600000, 784800),
  (2, 8600000, 9600000, 971200),
  (2, 9600000, 10600000, 1173600),
  (2, 10600000, 11600000, 1388400),
  (2, 11600000, 12600000, 1615200),
  (2, 12600000, 14000000, 1854000),
  (2, 14000000, 16000000, 2205600),
  (2, 16000000, 20000000, 2709600),
  (2, 20000000, NULL, 3723600);

-- ===================================
-- 부양가족 3인 이상
-- ===================================
INSERT INTO income_tax_brackets_2026 (dependent_count, income_from, income_to, tax_amount) VALUES
  (3, 0, 2800000, 0),
  (3, 2800000, 3600000, 90000),
  (3, 3600000, 4600000, 176400),
  (3, 4600000, 5600000, 306000),
  (3, 5600000, 6600000, 448800),
  (3, 6600000, 7600000, 603600),
  (3, 7600000, 8600000, 774000),
  (3, 8600000, 9600000, 960400),
  (3, 9600000, 10600000, 1162800),
  (3, 10600000, 11600000, 1377600),
  (3, 11600000, 12600000, 1604400),
  (3, 12600000, 14000000, 1843200),
  (3, 14000000, 16000000, 2194800),
  (3, 16000000, 20000000, 2698800),
  (3, 20000000, NULL, 3712800);

-- 확인 쿼리
SELECT 
  '간이세액표 업데이트 완료' AS 상태,
  COUNT(*) AS 총_행수,
  COUNT(DISTINCT dependent_count) AS 부양가족_구간수
FROM income_tax_brackets_2026;

-- ===================================
-- 소득세 계산 함수 개선 (선형 보간 적용)
-- ===================================
CREATE OR REPLACE FUNCTION calculate_income_tax_2026(
  p_taxable_income DECIMAL,
  p_dependent_count INTEGER DEFAULT 1
) RETURNS DECIMAL AS $$
DECLARE
  lower_bracket RECORD;
  upper_bracket RECORD;
  tax_amount DECIMAL := 0;
  income_diff DECIMAL;
  bracket_diff DECIMAL;
  tax_diff DECIMAL;
BEGIN
  -- 과세소득이 0 이하면 세금 없음
  IF p_taxable_income <= 0 THEN
    RETURN 0;
  END IF;
  
  -- 정확히 일치하는 구간 찾기
  SELECT itb.tax_amount INTO tax_amount
  FROM income_tax_brackets_2026 itb
  WHERE itb.dependent_count = p_dependent_count
    AND itb.income_from <= p_taxable_income
    AND (itb.income_to IS NULL OR itb.income_to > p_taxable_income)
  ORDER BY itb.income_from DESC
  LIMIT 1;
  
  -- 정확히 일치하는 구간이 있으면 반환
  IF tax_amount IS NOT NULL AND tax_amount > 0 THEN
    RETURN tax_amount;
  END IF;
  
  -- 구간 사이의 값이면 선형 보간
  SELECT * INTO lower_bracket
  FROM income_tax_brackets_2026
  WHERE dependent_count = p_dependent_count
    AND income_from <= p_taxable_income
  ORDER BY income_from DESC
  LIMIT 1;
  
  SELECT * INTO upper_bracket
  FROM income_tax_brackets_2026
  WHERE dependent_count = p_dependent_count
    AND income_from > p_taxable_income
  ORDER BY income_from ASC
  LIMIT 1;
  
  -- 상한선을 초과하는 경우 (최고 구간)
  IF upper_bracket.income_from IS NULL THEN
    RETURN COALESCE(lower_bracket.tax_amount, 0);
  END IF;
  
  -- 선형 보간 계산
  income_diff := p_taxable_income - lower_bracket.income_from;
  bracket_diff := upper_bracket.income_from - lower_bracket.income_from;
  tax_diff := upper_bracket.tax_amount - lower_bracket.tax_amount;
  
  tax_amount := lower_bracket.tax_amount + (income_diff / bracket_diff * tax_diff);
  
  RETURN ROUND(tax_amount, 0);
END;
$$ LANGUAGE plpgsql;

-- ===================================
-- 테스트 쿼리들
-- ===================================

-- 테스트 1: 과세소득 10,033,883원, 부양가족 1인
SELECT 
  '테스트 1: 과세소득 10,033,883원' AS 테스트,
  calculate_income_tax_2026(10033883, 1) AS 소득세,
  ROUND(calculate_income_tax_2026(10033883, 1) * 0.1) AS 지방소득세,
  calculate_income_tax_2026(10033883, 1) + ROUND(calculate_income_tax_2026(10033883, 1) * 0.1) AS 총_세금;

-- 테스트 2: 과세소득 8,750,000원, 부양가족 1인
SELECT 
  '테스트 2: 과세소득 8,750,000원' AS 테스트,
  calculate_income_tax_2026(8750000, 1) AS 소득세,
  ROUND(calculate_income_tax_2026(8750000, 1) * 0.1) AS 지방소득세;

-- 테스트 3: 과세소득 5,000,000원, 부양가족 1인
SELECT 
  '테스트 3: 과세소득 5,000,000원' AS 테스트,
  calculate_income_tax_2026(5000000, 1) AS 소득세,
  ROUND(calculate_income_tax_2026(5000000, 1) * 0.1) AS 지방소득세;

-- 간이세액표 확인 (부양가족 1인, 주요 구간)
SELECT 
  ROUND(income_from / 1000000.0, 1) || '~' || 
  COALESCE(ROUND(income_to / 1000000.0, 1)::TEXT, '∞') || '백만원' AS 구간,
  FORMAT('%,d원', tax_amount::INTEGER) AS 세액
FROM income_tax_brackets_2026
WHERE dependent_count = 1
  AND income_from >= 8000000
  AND income_from <= 12000000
ORDER BY income_from;
